# 🗄️ 模型配置持久化说明

## 📋 概述

模型管理器现在支持**自动持久化**功能，所有通过 `register_model` 注册的自定义模型会自动保存到 `model.json` 文件中，程序重启后自动加载。

## ✨ 特性

- ✅ **自动保存**：注册、更新、删除模型时自动保存到 JSON
- ✅ **自动加载**：程序启动时自动从 JSON 加载自定义模型
- ✅ **持久化别名**：模型别名也会保存
- ✅ **安全保护**：不能删除预定义模型

## 🚀 使用方法

### 1. 注册模型（自动保存）

```python
from modelmanager import model_manager

# 注册模型 - 自动保存到 model.json
model_manager.register_model(
    model_name="gemini-pro",
    provider="google",
    supports_vision=True
)

model_manager.register_model(
    model_name="llama-3-local",
    provider="ollama",
    api_base="http://localhost:11434/v1"
)
```

### 2. 添加别名（自动保存）

```python
# 添加别名 - 自动保存到 model.json
model_manager.add_model_alias("gemini", "gemini-pro")
model_manager.add_model_alias("llama3", "llama-3-local")
```

### 3. 更新模型配置（自动保存）

```python
# 更新配置 - 自动保存到 model.json
model_manager.update_model(
    "gemini-pro",
    max_tokens=32768,
    supports_functions=True
)
```

### 4. 删除模型（自动保存）

```python
# 删除自定义模型 - 自动保存到 model.json
model_manager.remove_model("my-custom-model")

# ⚠️ 不能删除预定义模型
model_manager.remove_model("gpt-4")  # 会提示错误
```

### 5. 程序重启后自动加载

```python
from modelmanager import model_manager

# 程序启动时自动加载 model.json 中的模型
# 无需手动操作！

# 直接使用注册的模型
from chat_demo import ChatBot
bot = ChatBot(model="gemini-pro")  # 使用之前注册的模型
```

## 📁 model.json 文件格式

```json
{
  "custom_models": [
    {
      "model_name": "gemini-pro",
      "provider": "google",
      "api_base": "https://generativelanguage.googleapis.com/v1",
      "api_key": null,
      "default_params": {},
      "supports_streaming": true,
      "supports_functions": true,
      "supports_vision": true,
      "max_tokens": 32768
    },
    {
      "model_name": "llama-3-local",
      "provider": "ollama",
      "api_base": "http://localhost:11434/v1",
      "api_key": null,
      "default_params": {},
      "supports_streaming": true,
      "supports_functions": false,
      "supports_vision": false,
      "max_tokens": null
    }
  ],
  "aliases": {
    "gemini": "gemini-pro",
    "llama3": "llama-3-local"
  }
}
```

## 🔍 完整示例

```python
#!/usr/bin/env python
"""完整示例：注册模型并使用"""

from modelmanager import model_manager
from chat_demo import ChatBot

# 1. 注册自定义模型
print("注册自定义模型...")
model_manager.register_model(
    model_name="gemini-pro",
    provider="google",
    supports_vision=True,
    max_tokens=32768
)

model_manager.register_model(
    model_name="llama-3-local",
    provider="ollama",
    api_base="http://localhost:11434/v1"
)

# 2. 添加别名
model_manager.add_model_alias("gemini", "gemini-pro")

# 3. 使用注册的模型
print("\n使用自定义模型聊天...")
bot = ChatBot(model="gemini")  # 使用别名
response = bot.chat("你好！")
print(response)

# 4. 更新配置
model_manager.update_model(
    "gemini-pro",
    supports_functions=True
)

# 5. 删除不需要的模型
# model_manager.remove_model("llama-3-local")

print("\n✅ 所有操作自动保存！重启程序后仍然有效。")
```

## 📊 实际使用场景

### 场景 1：添加本地 Ollama 模型

```python
from modelmanager import model_manager

# 注册所有本地 Ollama 模型
models = ["llama3", "qwen", "mistral", "codellama"]

for model in models:
    model_manager.register_model(
        model_name=f"{model}-local",
        provider="ollama",
        api_base="http://localhost:11434/v1"
    )
    model_manager.add_model_alias(model, f"{model}-local")

# 重启后直接可用！
```

### 场景 2：管理公司内部模型

```python
from modelmanager import model_manager

# 注册公司模型
model_manager.register_model(
    model_name="company-gpt-4",
    provider="openai",
    api_base="https://api.company.com/v1",
    max_tokens=128000
)

# 重启后依然可用
```

### 场景 3：批量导入配置

```python
import json
from modelmanager import model_manager

# 从配置文件批量导入
with open("my_models.json") as f:
    configs = json.load(f)

for config in configs:
    model_manager.register_model(**config)

# 全部自动保存到 model.json
```

## ⚙️ 高级用法

### 手动编辑 model.json

你也可以直接编辑 `model.json` 文件：

```json
{
  "custom_models": [
    {
      "model_name": "my-model",
      "provider": "openai",
      "api_base": "https://my-api.com/v1",
      "api_key": null,
      "default_params": {"temperature": 0.7},
      "supports_streaming": true,
      "supports_functions": true,
      "supports_vision": false,
      "max_tokens": 4096
    }
  ],
  "aliases": {
    "mm": "my-model"
  }
}
```

重启程序后自动生效！

### 备份和恢复

```bash
# 备份
cp model.json model.backup.json

# 恢复
cp model.backup.json model.json
```

### 迁移到其他机器

```bash
# 只需复制 model.json 文件
scp model.json user@remote:/path/to/project/new/
```

## 🔒 安全说明

### API Key 安全

- `model.json` 中的 `api_key` 默认为 `null`
- **建议**：API Key 统一在 `.env` 文件中管理
- 如果在 `model.json` 中保存 API Key，注意**不要提交到 Git**

```bash
# 添加到 .gitignore
echo "model.json" >> .gitignore
```

### 推荐做法

```python
# ✅ 推荐：API Key 在 .env 中
# .env 文件
API_KEY=your-api-key
BASE_URL=https://your-api.com/v1

# model.json 中不保存 key
model_manager.register_model(
    model_name="my-model",
    provider="openai"
    # 不设置 api_key，自动从环境变量读取
)
```

## ❓ 常见问题

### Q1: model.json 放在哪里？

A: 默认在 `new/model.json`，与 `modelmanager.py` 同目录。

### Q2: 可以修改文件名吗？

A: 可以，在创建管理器时指定：

```python
manager = ModelManager(model_file="my_models.json")
```

### Q3: 删除 model.json 会怎样？

A: 程序会正常运行，只是自定义模型需要重新注册。

### Q4: 预定义模型也会保存吗？

A: 不会，只保存通过 `register_model` 注册的自定义模型。

### Q5: 如何清空所有自定义模型？

A: 删除或清空 `model.json` 文件：

```bash
rm model.json
# 或
echo '{"custom_models": [], "aliases": {}}' > model.json
```

## 📚 相关文档

- 模型注册指南: `register_model_guide.md`
- 快速开始: `QUICKSTART.md`
- 项目总结: `PROJECT_SUMMARY.md`

## 🎉 总结

持久化功能让模型配置**一次注册，永久有效**：

1. ✅ **自动保存** - 注册、更新、删除时自动保存
2. ✅ **自动加载** - 程序启动时自动加载
3. ✅ **零配置** - 无需手动操作
4. ✅ **易备份** - 一个 JSON 文件搞定
5. ✅ **可迁移** - 复制文件即可迁移

现在你可以安心注册自定义模型了！🚀

